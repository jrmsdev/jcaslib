language: c

branches:
    only:
        - master

matrix:
    include:
        - os: linux
          sudo: false
          env:
              - GCC_COVERAGE
              - LD_LIBRARY_PATH=./build/lib
              - CHECK_COVERAGE=true
          dist: trusty
          addons:
              apt:
                  packages:
                      - libgdbm-dev
                      - bmake
                      - valgrind
          compiler: gcc
          before_script:
              - ./configure --use-gdbm
        - os: linux
          sudo: false
          env:
              - CLANG_VALGRIND
              - LD_LIBRARY_PATH=./build/lib
              - CHECK_VG=true
          dist: trusty
          addons:
              apt:
                  packages:
                      - libgdbm-dev
                      - bmake
          compiler: clang
          before_script:
              - ./configure --use-gdbm
        - os: osx
          env:
              - OSX_GCC
              - DYLD_LIBRARY_PATH=./build/lib
          compiler: gcc
          install:
              - brew update --quiet
              - brew install bmake
        - os: osx
          env:
              - OSX_CLANG
              - DYLD_LIBRARY_PATH=./build/lib
          compiler: clang
          install:
              - brew update --quiet
              - brew install bmake

script:
    - bmake depend
    - bmake -j2
    - bmake examples
    - bmake dist
    - ./build/bin/jcaslib
    - (test "true" = "$CHECK_VG" || test "true" = "$CHECK_COVERAGE") || bmake check
    - test "true" = "$CHECK_VG" && bmake check-valgrind
    - test "true" = "$CHECK_COVERAGE" && bmake check-coverage
    - /usr/bin/env true
